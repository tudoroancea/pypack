# AGENTS.md — pypack

## Project Overview

**pypack** is a tool that bundles Python applications into single-binary executables powered by [uv](https://docs.astral.sh/uv/) and [python-build-standalone](https://github.com/astral-sh/python-build-standalone). It concatenates a compiled C stub, a compressed Python runtime, and a ZIP payload (user code + dependencies) into one file that is simultaneously a native executable and a valid ZIP archive.

- **Version:** 0.2.0
- **License:** MIT
- **Platforms:** Linux x86_64/aarch64, macOS x86_64/arm64 (no Windows yet)

## Repository Structure

```
pypack.py          # Main build tool (~570 lines Python)
stub.c             # Native C launcher (~250 lines)
pyproject.toml     # Project metadata (hatchling build backend)
tests/
  test_pypack.py   # Integration tests (~740 lines)
examples/
  hello/           # Simple hello world package
  script/          # Single-script example
  withdeps/        # Example with requirements.txt
  withpyproject/   # Example with pyproject.toml deps
```

## Build & Development

### Prerequisites

| Tool | Purpose |
|------|---------|
| uv   | Python management + dependency resolution |
| zstd | Runtime compression |
| cc   | Compile C stub (gcc or clang) |
| tar  | Runtime archiving |

### Running Tests

```bash
uv run pytest tests/ -v
```

Tests are **integration tests** that exercise the full build → run pipeline. They require all build prerequisites (`uv`, `zstd`, `tar`, `cc`) to be installed. Tests are automatically skipped if any tool is missing.

Parallel execution is supported via `pytest-xdist`:
```bash
uv run pytest tests/ -v -n auto
```

### Installing the Tool

```bash
uv pip install -e .
```

This installs the `pypack` CLI entry point defined in `pyproject.toml` (`scripts.pypack = "pypack:main"`).

## Architecture

### Binary Layout

The output binary has this structure:
```
[C stub ELF/Mach-O] + [Python runtime tar.zst] + [App ZIP] + [32-byte trailer]
```

The trailer contains:
- Magic bytes: `b"PYPK\x00\x01\x00\x00"` (8 bytes)
- `runtime_offset` (u64 LE)
- `runtime_size` (u64 LE)
- `app_offset` (u64 LE)

### Build Pipeline (6 steps)

1. **Acquire Python** via `uv python install` + `uv python find`
2. **Install dependencies** via `uv pip install --target` (from `-r` or `--project`)
3. **Compile C stub** (`cc -O2 stub.c`) — tries static on Linux, falls back to dynamic
4. **Create app ZIP** — `__main__.py` bootstrap + user code + site-packages
5. **Compress runtime** — `tar | zstd -19` of the PBS installation
6. **Assemble** — concatenate all parts + trailer

### Runtime Flow

The C stub reads the trailer, hashes the runtime blob for cache keying, extracts to `~/.cache/pypack/<hash>/` if not cached, then `exec`s the cached Python interpreter with itself as the script argument. Python's `zipimport` finds `__main__.py` in the ZIP tail.

### Key Design Decisions

- ZIP central directories live at EOF, so prepending bytes keeps the ZIP valid
- Native extensions (`.so`/`.dylib`/`.pyd`) are extracted to disk at first run since `zipimport` can't load them
- `PYTHONNOUSERSITE=1` isolates from host site-packages
- The bootstrap uses `runpy.run_module()` for both packages and single scripts

## Code Conventions

- Single-file Python tool (`pypack.py`) — no internal package structure
- Functions prefixed with `uv_` handle uv integration
- `die()` for fatal errors (prints to stderr, exits 1)
- `require_tool()` checks for external tool availability
- Step numbers printed as `[N/6]` during build for progress indication
- No `.pyc`/`.pyo` files included in ZIPs
- `__pycache__` directories excluded from packaging

## Common Tasks

### Adding a new CLI flag

Add the argument to the `build_parser` in `main()`, then handle it in `cmd_build()`.

### Modifying the stub

Edit `stub.c`, then test by running a full build. The stub is compiled fresh each build unless a pre-built version exists in `stubs/`.

### Modifying the bootstrap

The bootstrap code is generated by `_make_bootstrap()` in `pypack.py`. It's a string template that becomes `__main__.py` inside the app ZIP.

## Troubleshooting

- **Tests failing with missing tools:** Ensure `uv`, `zstd`, `tar`, and `cc` are all on `$PATH`
- **Static linking fails on Linux:** Normal — falls back to dynamic linking automatically
- **macOS `-s` flag:** Apple clang doesn't support `-s` for stripping; omitted on macOS
